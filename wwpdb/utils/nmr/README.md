# NmrDpUtility - NMR data processing utility for OneDep system

NmrDpUtility is backend tool of OneDep system utilized for NMR deposition and validation. It accepts a coordinate file and various NMR data files, and generates combined NMR data file in either NEF or NMR-STAR format. Data processing status is reported through a JSON file. The software package can run outside of the OneDep system, called as standalone mode, for which see [instruction](../tests-nmr/README.md) for details.

## How to use
1. Instantiate NmrDpUtility class

```python
try:
    from wwpdb.utils.nmr.NmrDpUtility import NmrDpUtility  # OneDep system environment
except ImportError:
    from nmr.NmrDpUtility import NmrDpUtility  # Standalone mode

    util = NmrDpUtility()
```

2. Set primary NMR data source file and log file path (when you already have unified NMR data file in NEF or NMR-STAR format)

NmrDpUtility accepts unified NMR data file as primary data source by default. The unified NMR data file must contain assigned chemical shifts and restraints in a file. The validation results for the data source is reported into designated log file.

```python
    data_dir_path = 'wwpdb/utils/tests-nmr/mock-data/'
    entry_id = '2l9r'
    util.setSource(data_dir_path + entry_id + '.nef')  # primary data source must be unified NMR data
    util.setLog(data_dir_path + entry_id + '-nef-consistency-log.json')
    util.op('nmr-nef-consistency-check')
```
where *setSource()* and *setLog()* are methods to add unified NMR data file and log file. The last *op()* runs designated tasks. The other source files, such as coordinate file, chemical shift files, and restraint files, should be set through the following method. NmrDpUtility supports combining assigned chemical shifts and NMR restraints into single NMR data file.

3. Add input file path and parameters

Any input file paths and parameters should be set through *addInput()* method:

```python
   def addInput(self, name=None, value=None, type='file')
```

'name' should be chosen from effective names shown in a table below, and 'type' should be chosen from ('param', 'file', 'file_list', and 'file_dict_list'). At first, 'param' is used to set a named parameter, Next, 'file' and 'file_list' are used to specify single file path and multiple file paths respectively, whereas their file types are automatically decided by the 'name'. For example, 'pdbx' for coordinate file and 'nmr-star' for chemical shift file(s). Finally, 'file_dict_list' indicates 'value' is a list of dictionary, {'file_name': ?, 'file_type': ?, 'original_file_name' (optional): ?}, and used to set multiple file paths with each file type and optionally the author provided original file name.

name|effective type|description
----|--------------|-----------
coordinate_file_path|file|Set a PDBx/mmCIF coordinate file. The file type is 'pdbx' by default.
chem_shift_path_list|file_list, file_dict_list|Set chemical shift file(s), formally we accepted multiple chemical shift files. The file type is 'nmr-star'.
restraint_file_path_list|file_list, file_dict_list|Set NMR restraint files in NMR-STAR format so that the file type is 'nmr-star'.
atypical_restraint_file_path_list|file_dict_list|Set software-native formatted NMR restraint files or spectral peak list files. The file types are set by the dictionary as described above.
report_file_path|file|Set input report file path of generated by the previous data checking task ('nmr-nef-consistency-check', 'nmr-str-consistency-check', 'nmr-cs-nef-consistency-check', 'nmr-cs-str-consistency-check').
nmr_cif_file_path|file|Set CIF formatted NMR unified data file path. NOTE: used for BMRB internal processing.
remediation|param|Boolean value. True for legacy separated data file deposition. False for native NMR unified data file deposition/
internal|param|Boolean value. Set internal mode. NOTE: used for internal only.
bmrb_only|param|Boolean value. Set BMRB only mode. NOTE: used for BMRB only.
bmrb_id|param|Set BMRB ID. NOTE: used for BMRB only.
merge_any_pk_as_is|param|Boolean value. Must be True until NMR data remediation (Phase 2),
nonblk_anomalous_cs|param|Boolean value. True for OneDep system because any anomalous chemical shift values should not be blocker.
nonblk_bad_nterm|param|Boolean value. True for OneDep system because biocurator can handle atom name inconsistency of N-terminus residue.
update_poly_seq|param|Boolean value. True for OneDep system.
resolve_conflict|param|Boolean value. True for OneDep system.
check_mandatory_tag|param|Boolean value. True for OneDep system.
check_auth_seq|param|Boolean value. False for OneDep system.
validation_server|param|Boolean value. False for OneDep system. True for standalone validation server.
transl_pseudo_name|param|Boolean value. False for OneDep system. Whether to convert pseudo atom nomenclature in NMR unified data file.
tolerant_seq_align|param|Boolean value. Set True for 'nmr-str-consistency-check', 'nmr-str2str-deposit', 'nmr-str2cif-deposit', 'nmr-str2nef-release', and 'nmr-str2cif-annotate' workflow operations. Whether to ignore sequence alignment error due to residue variant.
fix_format_issue|param|Boolean value. True for legacy separated file data file deposition or release mode. 
excl_missing_data|param|Boolean value. True for legacy separated file data file deposition. Whether to exclude missing mandatory data.
cmpl_missing_data|param|Boolean value. True for legacy separated file data file deposition. Whether to complement missing data (add missing pseudo atoms in NMR restraints)
trust_pdbx_nmr_ens|param|Boolean value. True for release mode. Whether to trust pdbx_nmr_ensemble to get total number of models.
rmsd_not_superimposed|param|Positive floating-point value. Criterion for detection of not superimposed model. (default value is 2.0 Å)
rmsd_overlaid_exactly|param|Positive floating-potnt value. Criterion for detection of exactly overlaid models. (default value is 0.01 Å)

4. Add primary output file path, other output file path and parameters

NmrDpUtility outputs processed data source file as primary output. The primary output file path /should be specified by *setDestination()* method. When you select NEF The other output file path and parameters should be set through *addOutput()* method:

```python
    addOutput(self, name=None, value=None, type='file')

```

'name' should be chosen from effective names shown in a table below, and 'type' should be chosen from ('param', 'file', and 'file_list'). At first, 'param' is used to set a named parameter, Next, 'file' and 'file_list' are used to specify single file path and multiple file paths respectively, whereas their file types are automatically decided by the 'name'. For example, 'pdbx' for coordinate file and 'nmr-star' for chemical shift file(s).

name|effective type|description
----|--------------|-----------
nmr_cif_file_path|file|Set CIF formatted NMR-STAR unified data file. Effective in 'nmr-nef2cif-deposit', 'nmr-str2cif-deposit', and 'nmr-str2cif-annotate' workflow operations.
nmr-star_file_path|file|Set NMR-STAR unified data file. Effective in 'nmr-nef2str-deposit', and 'nmr-nef2cif-deposit' workflow operations.
report_file_path|file|Set auxiliary report file path when setLog() is occupied for the previous task.
entry_id|param|Set entry ID. (default value is extracted from coordinate file if available, otherwise, 'UNNAMED')
retain_original|param|Boolean value. True by default. Whether to retain original content if possible.
leave_intl_note|param|Boolean value. True by default. Whether to leave internal commentary note in processed NMR-STAR file.
reduced_atom_notation|param|Boolean value. True by default. Whether to use reduced atom notation in warning/error message.

5. Invoke defined workflow operation

A series of data processing will executed When invoke *op()* for a given workflow operations.

op() 's argument|role
----------------|-----------
nmr-nef-consistency-check|Validate NEF data file
nmr-str-consistency-check|Validate NMR-STAR data file
nmr-nef2str-deposit|Convert NEF to NMR-STAR file
nmr-nef2cif-deposit|Convert NEF to NMR-STAR and CIF formatted NMR-STAR file for OneDep system
nmr-str2str-deposit|Convert NMR-STAR file
nmr-str2cif-deposit|Convert NMR-STAR file and generate CIF formatted NMR-STAR file for OneDep system
nmr-str2nef-release|Convert NMR-STAR file to NEF for OneDep release module.
nmr-cs-nef-consistency-check|Deprecated.
nmr-cs-str-consistency-check|Deprecated.
nmr-cs-mr-merge|Combine assigned chemical shifts and NMR restraints into NMR unified data file.
nmr-str2cif-annotate|OneDep system only, Update NMR-STAR file based on annotated model file.

## Typical workflow operations

As of now, OneDep supports single NMR data file deposition using NMR unified data file in NEF or NMR-STAR and conventional separated NMR data file deposition requires assigned chemical shift file and set of NMR restraint files.

### Single NMR data file deposition

At first, NMR unified data file must be validated and cross-checked by given coordinate file. Then, file conversion workflow will follow where report file is required as input source.

For example, NEF to CIF formatted NMR-STAR file conversion

```python
    util.setSource(data_dir_path + entry_id + '.nef)
    util.addInput(name='coordinate_file_path', value=data_dir_path + entry_id + '.cif', type='file')
    util.addInput(name='nonblk_anomalous_cs', value=True, type='param')
    util.addInput(name='nonblk_bad_nterm', value=True, type='param')
    util.addInput(name='resolve_conflict', value=True, type='param')
    util.addInput(name='check_mandatory_tag', value=True, type='param')
    util.setLog(data_dir_path + entry_id + '-nef-consistency-log.json')  # this report file is reused in successive data conversion workflow
    util.setVerbose(False)

    util.op('nmr-nef-consistency-check')

    util.setSource(data_dir_path + entry_id + '.nef)
    util.addInput(name='coordinate_file_path', value=data_dir_path + entry_id + '.cif', type='file')
    util.addInput(name='report_file_path', value=data_dir_path + entry_id '-nef-consistency-log.json', type='file')  # take report file of the 'nmr-nef-consistency-check' workflow operation
    util.addInput(name='nonblk_anomalous_cs', value=True, type='param')
    util.addInput(name='nonblk_bad_nterm', value=True, type='param')
    util.addInput(name='resolve_conflict', value=True, type='param')
    util.addInput(name='check_mandatory_tag', value=True, type='param')
    util.setLog(data_dir_path + entry_id '-nef2cif-deposit-log.json')  # report file for data conversion
    util.setDestination(data_dir_path + entry_id '-next.nef')  # the primary destination is the converted NEF file of the original data source
    util.addOutput(name='nmr-star_file_path', value=data_dir_path + entry + '-nef2cif.str', type='file')  # converted NMR-STAR file
    util.addOutput(name='nmr_cif_file_path', value=data_dir_path + entry_id + '-nef2cif.cif', type='file')  # converted CIF formatted NMR-STAR file
    util.addOutput(name='report_file_path', value=data_dir_path + entry_id + '-nef2cif-str-deposit-log.json', type='file')  # report file for the obtained NMR-STAR file
    util.addOutput(name='entry_id', value=entry_id, type='param')
    util.addOutput(name='leave_intl_note', value=False, type='param')
    util.setVerbose(False)

    util.op('nmr-nef2cif-deposit')
```

As for NMR-STAR (NMR unified data) to CIF formatted NMR-STAR file conversion

```python
    util.setSource(data_dir_path + entry_id + '.str)
    util.addInput(name='coordinate_file_path', value=data_dir_path + entry_id + '.cif', type='file')
    util.addInput(name='nonblk_anomalous_cs', value=True, type='param')
    util.addInput(name='nonblk_bad_nterm', value=True, type='param')
    util.addInput(name='resolve_conflict', value=True, type='param')
    util.addInput(name='check_mandatory_tag', value=True, type='param')
    util.setLog(data_dir_path + entry_id + '-str-consistency-log.json')  # this report file is reused in successive data conversion workflow
    util.setVerbose(False)

    util.op('nmr-str-consistency-check')

    util.setSource(data_dir_path + entry_id + '.str)
    util.addInput(name='coordinate_file_path', value=data_dir_path + entry_id + '.cif', type='file')
    util.addInput(name='report_file_path', value=data_dir_path + entry_id '-str-consistency-log.json', type='file')  # take report file of the 'nmr-str-consistency-check' workflow operation
    util.addInput(name='nonblk_anomalous_cs', value=True, type='param')
    util.addInput(name='nonblk_bad_nterm', value=True, type='param')
    util.addInput(name='resolve_conflict', value=True, type='param')
    util.addInput(name='check_mandatory_tag', value=True, type='param')
    util.setLog(data_dir_path + entry_id '-str2cif-deposit-log.json')  # report file for data conversion 
    util.setDestination(data_dir_path + entry_id '-next.str')  # the primary destination is the converted NMR-STAR file of the original data source 
    util.addOutput(name='nmr_cif_file_path', value=data_dir_path + entry_id + '-str2cif.cif', type='file')  # converted CIF formatted NMR-STAR file
    util.addOutput(name='report_file_path', value=data_dir_path + entry_id + '-str2cif-str-deposit-log.json', type='file')  # report file for the obtained NMR-STAR file
    util.addOutput(name='entry_id', value=entry_id, type='param')
    util.addOutput(name='leave_intl_note', value=False, type='param')
    util.setVerbose(False)

    util.op('nmr-str2cif-deposit')
```

### Separated NMR data file deposition

Conventional NMR deposition to OneDep system accepts assigned chemical shift file and software native restraint files and combined contents into NMR unified data file.

```python
    model_file_path = 'D_1000259961_model-upload_P1.cif.V1'
    cs_file_path = 'D_1000259961_cs-upload_P1.str.V1'
    mr_file_type = ['nm-res-xpl', 'nm-res-xpl', 'nm-res-xpl', 'nm-res-xpl', 'nm-res-xpl']
    mr_file_path = ['HBDA-5.tbl', 'jhnhacoup3.tbl', 'tgmd3_rdc_caco_ave_v3.tbl', 'tgmd3_rdc_caha_ave_v4.tbl', 'tgmd3_rdc_nh_CHB.tbl']
    util.addInput(name='chem_shift_file_path_list', value=[{'file_name': cs_file_path, 'file_type': 'nmr-star', 'original_file_name': 'TGM1D3.str'}], type='file_dict_list')
    ar_path_list = []
    for i, ar_path in enumerate(mr_file_path):
        ar_path_list.append({'file_name': data_dir_path + ar_path, 'file_type': mr_file_type[i], 'original_file_name': ar_path})
    util.addInput(name='atypical_restraint_file_path_list', value=ar_path_list, type='file_dict_list')
    util.addInput(name='coordinate_file_path', value=data_dir_path + model_file_path, type='file')
    util.addInput(name='nonblk_anomalous_cs', value=True, type='param')
    util.addInput(name='nonblk_bad_nterm', value=True, type='param')
    util.addInput(name='resolve_conflict', value=True, type='param')
    util.addInput(name='check_mandatory_tag', value=False, type='param')
    util.addInput(name='remediation', value=True, type='param')
    util.setLog(data_dir_path + entry_id + '-cs-str-consistency-log.json')
    util.setDestination(data_dir_path + entry_id + '_cs_mr_merged.str')  # combined NMR-STAR file
    util.setVerbose(False)

```

The obtained NMR-STAR file will be validated as NMR unified data file using 'nmr-str-consistency-check' and 'nmr-str2cif-deposit' workflow operations in OneDep system.

### Appendix

The codes used for specifying each file type in NmrDpUtility are compatible with OneDep system as follows:

NmrDpUtility|OneDep|description
------------|------|-----------
nmr-star|nm-shi or nm-uni-str|NMR data in NMR-STAR format
nef|nm-uni-nef|NMR data in NEF (NMR Exchange Format)
pdbx|co-cif|Coordinates in PDBx/mmCIF format
nm-res-amb|nm-res-amb|Restraint file in AMBER format
nm-aux-amb|nm-res-amb|Topology file in AMBER format
nm-res-ari|nm-res-ari|Restraint file in ARIA format
nm-res-bio|nm-res-bio|Restraint file in BIOSYM format
nm-res-cha|nm-res-cha|Restraint file in CHARMM format
nm-res-cns|nm-res-cns|Restraint file in CNS format
nm-res-cya|nm-res-cya|Restraint file in CYANA format
nm-res-dyn|nm-res-dyn|Restraint file in DYNAMO/PALES/TALOS format
nm-res-gro|nm-res-gro|Restraint file in GROMACS format
nm-aux-gro|nm-aux-gro|Topology file in GROMACS format
nm-res-isd|nm-res-isd|Restraint file in ISD format
nm-res-ros|nm-res-ros|Restraint file in ROSETTA format
nm-res-syb|nm-res-syb|Restraint file in SYBYL format
nm-res-xpl|nm-res-xpl|Restraint file in XPLOR-NIH format
nm-res-oth|nm-res-oth|Restraint file in other format
nm-pea-any|nm-pea-any|Any spectral peak list file

